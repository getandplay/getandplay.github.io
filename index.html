<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Neal, WPF, C#">










<meta name="description" content=".NET core\WPF\.NET">
<meta property="og:type" content="website">
<meta property="og:title" content="Neal&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Neal&#39;s Blog">
<meta property="og:description" content=".NET core\WPF\.NET">
<meta property="og:locale" content="English">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Neal&#39;s Blog">
<meta name="twitter:description" content=".NET core\WPF\.NET">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","Sidebar Display, available value (only for Muse | Mist)":["always  expand for all pages automatically"],"display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Neal's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="English">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Neal's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            Schedule
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/21/Learn-more-about-how-WPF-Dispatcher-works-PushFrame/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Neal chen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/badboy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Neal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/21/Learn-more-about-how-WPF-Dispatcher-works-PushFrame/" itemprop="url">Learn more about how WPF Dispatcher works.(Part 2 - PushFrame)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-21T16:14:17-06:00">
                2019-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>In the previous article <a href="../2019/05/16/Learn-more-about-how-WPF-Dispatcher-works-Invoke-and-InvokeAsync">“Learn more about how WPF Dispatcher works. (Invoke and InvokeAsync)”</a>, we found that <code>Dispatcher.Invoke</code> depends on <code>Dispatcher.PushFrame</code> method to wait without blocking. But how does <code>Dispatcher.PushFrame</code> work?</p>
<p>In this blog, we will introduce more details about <code>Dispatcher</code>.</p>
<hr>
<h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><blockquote>
<p>The original link is <a href="https://blog.walterlv.com/post/dotnet/2017/09/26/dispatcher-push-frame.html" target="_blank" rel="noopener">深入了解 WPF Dispatcher 的工作原理（PushFrame 部分）</a>. But this blog was written in Chinese, so I translate its content to English. Waterlv is an MVP(Microsoft Most Valuable Professional), and he is good at .NET Core\WPF\.NET. Here is his <a href="https://blog.walterlv.com/" target="_blank" rel="noopener">Blog</a>.</p>
</blockquote>
<hr>
<h3 id="Dispatcher-PushFrame"><a href="#Dispatcher-PushFrame" class="headerlink" title="Dispatcher.PushFrame"></a>Dispatcher.PushFrame</h3><p>If you are a WPF developer, you must have known the <code>ShowDialog</code> method of the <code>Window</code> class. But do you know how does <code>ShowDialog</code> method work? Why does the method which calls <code>ShowDialog</code> continue to execute after the window returns?</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> w = <span class="keyword">new</span> FooWindow();</span><br><span class="line">w.ShowDialog();</span><br><span class="line">Debug.WriteLine(w.Bar);</span><br></pre></td></tr></table></figure>
<p>To answer these questions mentioned above, we have to read the source code of <code>Dispatcher.PushFrame</code> method. But before reading, we should learn some knowledge about the <code>DoEvents</code> method in <code>Windows Forms</code>.</p>
<h3 id="DoEvents"><a href="#DoEvents" class="headerlink" title="DoEvents"></a>DoEvents</h3><p>The <code>DoEvents</code> method in the <code>Windows Forms</code> allows you to insert a UI rendering operation during executing a time-consuming operation, and it makes your application look like it doesn’t stop responding.</p>
<p>Here are the codes of <code>DoEvents</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SecurityPermissionAttribute(SecurityAction.Demand, Flags = SecurityPermissionFlag.UnmanagedCode)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoEvents</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DispatcherFrame frame = <span class="keyword">new</span> DispatcherFrame();</span><br><span class="line">    Dispatcher.CurrentDispatcher.BeginInvoke(DispatcherPriority.Background,</span><br><span class="line">        <span class="keyword">new</span> DispatcherOperationCallback(ExitFrame), frame);</span><br><span class="line">    Dispatcher.PushFrame(frame);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">object</span> <span class="title">ExitFrame</span>(<span class="params"><span class="keyword">object</span> f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ((DispatcherFrame)f).Continue = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Firstly, we should know the conclusion mentioned above that <code>Dispacther.PushFrame</code> method can wait without blocking UI thread. ( The theory will be posted below, but now just remember this conclusion.)</p>
<p>And base on the conclusion, we now analyze the theory of <code>DoEvents</code> which is posted above. And its steps are as followed.</p>
<ol>
<li><p>Add an instance of <code>DispatcherOperation</code> with <code>Background</code> priority (4) to execute the <code>ExitFrame</code> method.</p>
</li>
<li><p>Call the <code>Dispatcher.PushFrame</code> method to wait without blocking UI thread.</p>
</li>
<li><p>Due to the priority of user’s input is <code>Input</code> (5) and the priority of the UI response is <code>Loaded</code> (6) and the priority of rendering is <code>Render</code> (7), they all are higher than <code>Background</code> (4), so the <code>ExitFrame</code> method can only be executed after all UI task have been executed.</p>
</li>
<li><p>The value of <code>Dispatcher.Continue</code> will be set to <code>false</code> when executing the <code>ExitFrame</code> method.</p>
</li>
</ol>
<p>Base on the function of <code>DoEvents</code>, we can guess that the goal of setting the value of <code>DispatcherFrame.Continue</code> to <code>false</code> is to end the wait of <code>Dispatcher.PushFrame(frame)</code>, so that the subsequent codes can be executed.</p>
<p>So according to the guess, we may know the steps of waiting without blocking UI thread.</p>
<ol>
<li><p>Call <code>Dispatcher.PushFrame(frame)</code> to wait without blocking.</p>
</li>
<li><p>Set <code>frame.Continue = false</code> to end the wait and execute the subsequent codes.</p>
</li>
</ol>
<p>It is easier to read the source codes of the <code>Dispatcher.PushFrame</code> with the guess and information above.</p>
<h3 id="Source-codes-of-PushFrame"><a href="#Source-codes-of-PushFrame" class="headerlink" title="Source codes of PushFrame"></a>Source codes of <code>PushFrame</code></h3><p>Here are the codes.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SecurityCritical, SecurityTreatAsSafe </span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PushFrameImpl</span>(<span class="params">DispatcherFrame frame</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SynchronizationContext oldSyncContext = <span class="literal">null</span>;</span><br><span class="line">    SynchronizationContext newSyncContext = <span class="literal">null</span>;</span><br><span class="line">    MSG msg = <span class="keyword">new</span> MSG();</span><br><span class="line"> </span><br><span class="line">    _frameDepth++;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Change the CLR SynchronizationContext to be compatable with our Dispatcher.</span></span><br><span class="line">        oldSyncContext = SynchronizationContext.Current;</span><br><span class="line">        newSyncContext = <span class="keyword">new</span> DispatcherSynchronizationContext(<span class="keyword">this</span>);</span><br><span class="line">        SynchronizationContext.SetSynchronizationContext(newSyncContext);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span>(frame.Continue)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!GetMessage(<span class="keyword">ref</span> msg, IntPtr.Zero, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"> </span><br><span class="line">                TranslateAndDispatchMessage(<span class="keyword">ref</span> msg);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// If this was the last frame to exit after a quit, we</span></span><br><span class="line">            <span class="comment">// can now dispose the dispatcher.</span></span><br><span class="line">            <span class="keyword">if</span>(_frameDepth == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(_hasShutdownStarted)</span><br><span class="line">                &#123;</span><br><span class="line">                    ShutdownImpl();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Restore the old SynchronizationContext.</span></span><br><span class="line">            SynchronizationContext.SetSynchronizationContext(oldSyncContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        _frameDepth--;</span><br><span class="line">        <span class="keyword">if</span>(_frameDepth == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// We have exited all frames.</span></span><br><span class="line">            _exitAllFrames = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There are two points which need to pay attention to :</p>
<ol>
<li><code>_frameDepth</code> field.</li>
<li>The codes which are surrounded by <code>while</code>.</li>
</ol>
<p>Let’s begin with the <code>_frameDepth</code> field. Every time you call the <code>PushFrame</code> method, you should pass an instance of <code>DispatcherFrame</code>, and the <code>_frameDepth</code> field will add 1 when another <code>PushFrame</code> is called during the period of <code>PushFrame</code>. So, one by one, the <code>DispatcherFrame</code> is nested in layers.</p>
<p>Then, we read the codes surrounded by <code>while</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(frame.Continue)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!GetMessage(<span class="keyword">ref</span> msg, IntPtr.Zero, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    TranslateAndDispatchMessage(<span class="keyword">ref</span> msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Do you remember the guess mentioned above? After reading these codes we noticed that the condition of the <code>while</code> is <code>frame.Continue</code>, and if its value is <code>false</code> the loop will be exited, and the <code>PushFrame</code> method will be returned, then the <code>_frameDepth</code> field will subtract 1. If all the <code>frame.Continue</code> are set to <code>false</code>, the <code>Main</code> method will be exited.</p>
<p>And, what will happen if the value of <code>frame.Continue</code> is always true? Obviously, it will enter a <code>dead loop</code>.  But you can’t insert any UI operations to a <code>dead loop</code>, so how does it execute the UI operations? In the codes of this method, there are two possibilities, one is that <code>GetMessage</code> method allows the application to continue processing window messages, the other is that <code>TranslateAndDispatchMessage</code> method allows us to continue processing window messages. (The task queue of <code>Dispatcher</code> depends on the message mechanism of windows which is mentioned in the previous article).</p>
<p><img src="/2019/05/21/Learn-more-about-how-WPF-Dispatcher-works-PushFrame/2019-5-21-1.png" alt></p>
<p>Unfortunately, both methods call the unmanaged code, it is hard to know their theories by reading the source codes. But, we can debug the <code>.NET Framework</code> source code by source code debugging technology. And we found that <code>GetMessage</code> method is running all the time, and the <code>TranslateAndDispatchMessage</code> does not seem to be called. So we believe that the key to waiting without blocking is in the <code>GetMessage</code> method. For more information about <code>.NET Framework</code> source code debugging technology, visit <a href="http://blog.lindexi.com/lindexi//post/%E8%B0%83%E8%AF%95-ms-%E6%BA%90%E4%BB%A3%E7%A0%81/" target="_blank" rel="noopener">调试 ms 源代码 - 林德熙</a>.</p>
<p>After reading the codes of <code>GetMessage</code>, we found <code>messagePump</code> which is an instance of <code>UnsafeNagtiveMethods.ITfMessagePump</code>. And we can know how does message loop work by using the source code debugging technology.</p>
<h3 id="Debugging-the-source-code-to-get-how-does-PushFrame-work"><a href="#Debugging-the-source-code-to-get-how-does-PushFrame-work" class="headerlink" title="Debugging the source code to get how does PushFrame work"></a>Debugging the source code to get how does <code>PushFrame</code> work</h3><p>We add <code>OnStylusDown</code> method for <code>MainWindow</code>‘s <code>StylusDown</code> event.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnStylusDown</span>(<span class="params"><span class="keyword">object</span> sender, StylusDownEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Dispatcher.Invoke(() =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine();</span><br><span class="line">        <span class="keyword">new</span> MainWindow().ShowDialog();</span><br><span class="line">    &#125;, DispatcherPriority.Background);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In these codes, both <code>Dispatcher.Invoke</code> and <code>ShowDialog</code> methods will call <code>PushFrame</code>. After running this application, every time we touch the <code>MainWindow</code>, we can found that there will add two <code>PushFrame</code> in the call-stack subwindow in VS. One is called by the <code>Invoke</code> method and the other is called by <code>ShowDialog</code>.</p>
<p>After each <code>PushFrame</code> executes, there is a transition between host and manage. Then message processing is followed, and the touching message is called from the message processing.</p>
<p>So, it’s sure that every time we execute <code>PushFrame</code> the unmanaged code will open a new message loop. When the window showed by <code>ShowDialog</code> closed or the <code>Invoke</code> has finished the message loop which is created by <code>PushFrame</code> will be exited. Therefore, the subsequent codes which are blocked by <code>while</code> can be executed. After the <code>PushFrame</code> of the Main method is exited, this application will close.</p>
<p><img src="/2019/05/21/Learn-more-about-how-WPF-Dispatcher-works-PushFrame/2017-09-26-03-47-20.png" alt></p>
<h3 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h3><ol>
<li>Every time the <code>PushFrame</code> executed, a new message loop will be created, and the <code>_frameDepth</code> will add 1.</li>
<li>In the new message loop, it can handle all kinds of Window’s message, some of them are transmitted in the form of events, and some are tasks that are added to the <code>PriorityQueue&lt;DispatcherOperation&gt;</code>.</li>
<li>After exiting the <code>PushFrame</code> method, the message loop which is created by this code will be exited too. And the subsequent code of previous <code>PushFrame</code> will be executed.</li>
<li>If all the <code>PushFrame</code> exited, the application will be closed.</li>
<li>The <code>While</code> loop in <code>PushFrame</code> will block the main thread, but it can handle the messages in the <code>loop</code>, so it looks like the main thread is not blocked.</li>
</ol>
<h3 id="The-defects-of-PushFrame"><a href="#The-defects-of-PushFrame" class="headerlink" title="The defects of PushFrame"></a>The defects of <code>PushFrame</code></h3><ol>
<li><p><code>PushFrame</code> depends on the Windows’ message loop, and there are some bugs about multiple message loops. Like,</p>
<ul>
<li><a href="https://stackoverflow.com/q/19411613/6233938" target="_blank" rel="noopener">c# - PushFrame locks up WPF window when user is moving window - Stack Overflow</a></li>
</ul>
</li>
<li><p>Base on <code>PushFrame</code>‘s block mechanism, the unexpected reentrancy problem may happen is a single thread application. visit <a href="https://blog.walterlv.com/post/reentrancy-in-async-method.html" target="_blank" rel="noopener">异步任务中的重新进入（Reentrancy）</a> for more information about the <code>Reentrancy</code>.</p>
</li>
</ol>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><p>PushFrame/DispatcherFrame</p>
<ul>
<li><a href="http://referencesource.microsoft.com/#WindowsBase/Base/System/Windows/Threading/Dispatcher.cs" target="_blank" rel="noopener">Dispatcher.cs</a></li>
<li><a href="https://stackoverflow.com/questions/33002966/wpf-dispatcherframe-magic-how-and-why-this-works" target="_blank" rel="noopener">c# - WPF DispatcherFrame magic - how and why this works? - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/questions/41759665/for-what-is-pushframe-needed" target="_blank" rel="noopener">c# - For what is PushFrame needed? - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/questions/2665191/wpf-dispatcher-pushframe" target="_blank" rel="noopener">multithreading - WPF - Dispatcher PushFrame() - Stack Overflow</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/system.windows.threading.dispatcherframe.aspx" target="_blank" rel="noopener">DispatcherFrame Class (System.Windows.Threading)</a></li>
<li><a href="https://www.codeproject.com/Articles/152137/DispatcherFrame-Look-in-Depth" target="_blank" rel="noopener">DispatcherFrame. Look in-Depth - CodeProject</a></li>
</ul>
</li>
<li><p>Message loop of Windows</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Message_loop_in_Microsoft_Windows" target="_blank" rel="noopener">Message loop in Microsoft Windows - Wikipedia</a></li>
<li><a href="https://stackoverflow.com/questions/11417216/understanding-the-dispatcher-queue/11419762" target="_blank" rel="noopener">c# - Understanding the Dispatcher Queue - Stack Overflow</a></li>
<li><a href="http://blog.csdn.net/royyeah/article/details/4785473" target="_blank" rel="noopener">详解WPF线程模型和Dispatcher - 踏雪无痕 - CSDN博客</a></li>
</ul>
</li>
<li><p><a href="http://blog.lindexi.com/lindexi//post/%E8%B0%83%E8%AF%95-ms-%E6%BA%90%E4%BB%A3%E7%A0%81/" target="_blank" rel="noopener">调试 ms 源代码 - 林德熙</a>.</p>
</li>
<li><a href="https://stackoverflow.com/q/19411613/6233938" target="_blank" rel="noopener">c# - PushFrame locks up WPF window when user is moving window - Stack Overflow</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/16/Learn-more-about-how-WPF-Dispatcher-works-Invoke-and-InvokeAsync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Neal chen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/badboy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Neal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/16/Learn-more-about-how-WPF-Dispatcher-works-Invoke-and-InvokeAsync/" itemprop="url">Learn more about how WPF Dispatcher works.(Invoke and InvokeAsync)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-16T18:08:54-06:00">
                2019-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>The <code>WPF</code> developers cannot avoid using the <code>Dispatcher</code> class. When we have to access controls or other UI parts on other threads (not <code>UI</code> thread), we should use <code>Dispatcher.InvokeAsync</code> or <code>Dispatcher.Invoke</code> method. Also, <code>Dispatcher</code> can be used to delay a task until the current task is executed.</p>
<p>Developers often used <code>Dispatcher.BeginInvoke</code> in the past. And Microsoft adds a new method which’s name is <code>Dispatcher.InvokeAsync</code> in <code>.NET Framework 4.5</code>.</p>
<p>Are there any differences between these methods? And how does <code>Dispatcher</code> work?</p>
<h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><blockquote>
<p>The original link is <a href="https://blog.walterlv.com/post/dotnet/2017/09/26/dispatcher-invoke-async.html" target="_blank" rel="noopener">深入了解 WPF Dispatcher 的工作原理（Invoke/InvokeAsync 部分）</a>. But this blog was written in Chinese, so I translate its content to English. Waterlv is an MVP(Microsoft Most Valuable Professional), and he is good at .NET Core\WPF\.NET. Here is his <a href="https://blog.walterlv.com/" target="_blank" rel="noopener">Blog</a>.</p>
</blockquote>
<hr>
<h3 id="BeginInvoke-and-InvokeAsync"><a href="#BeginInvoke-and-InvokeAsync" class="headerlink" title="BeginInvoke and InvokeAsync"></a><code>BeginInvoke</code> and <code>InvokeAsync</code></h3><p><code>BeginInvoke</code> method has existed when the <code>Dispatcher</code> class is added in the <code>.NET framework 3.0</code>. Are you familiar with <code>Begin</code> prefix? Yes, it is the <code>Begin\End</code> asynchronous programming model(APM) which is introduced in <code>.NET Framework 1.1</code>. Although <code>BeginInvoke</code> is not completely implemented according to the APM model(there is no End and no <code>IAsyncResult</code> result), but this method is also thread-related. Not only does the name carry <code>Begin</code> for the means of asynchronous execution, but there are still ancient types like <code>Delegate</code> in the parameter list. All the details above show that the <code>BeginInvoke</code> method is an <em>old</em> API.</p>
<p>Every developer is still feeling excited about the <code>async/await</code> asynchronous model which was introduced in <code>.NET Framework 4.5</code>‘s updates. This model allows developers to write asynchronous codes as simple as synchronous codes. This is a new asynchronous programming model which is recommended by Microsoft, and its name is <code>TAP</code> (Task-based Asynchronous pattern). And <code>Dispatcher.InvokeAsync</code> was introduced in this version. So, what are the differences between <code>BeginInvoke</code> and <code>InvokeAsync</code>?</p>
<h3 id="Differences"><a href="#Differences" class="headerlink" title="Differences"></a>Differences</h3><p>Firstly, we should read the source codes of these methods.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Browsable(false), EditorBrowsable(EditorBrowsableState.Never)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">BeginInvoke</span>(<span class="params">DispatcherPriority priority, Delegate method</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Browsable(false), EditorBrowsable(EditorBrowsableState.Never)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">BeginInvoke</span>(<span class="params">DispatcherPriority priority, Delegate method, <span class="keyword">object</span> arg</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Browsable(false), EditorBrowsable(EditorBrowsableState.Never)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">BeginInvoke</span>(<span class="params">DispatcherPriority priority, Delegate method, <span class="keyword">object</span> arg, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">BeginInvoke</span>(<span class="params">Delegate method, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">BeginInvoke</span>(<span class="params">Delegate method, DispatcherPriority priority, <span class="keyword">params</span> <span class="keyword">object</span>[] args</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>There are five overload methods, and it is easy to find that three of them are marked by special attribute to make them invisible in IntelliSense list (<em>but you can find them when you use ReSharper</em>). Are there any differences among these methods? The answer is NO. After reading these methods’ code, we can find that they all call the same method named <code>LegacyBeginInvokeImpl</code>. Here is the code of the method.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SecuritySafeCritical</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> DispatcherOperation <span class="title">LegacyBeginInvokeImpl</span>(<span class="params">DispatcherPriority priority, Delegate method, <span class="keyword">object</span> args, <span class="keyword">int</span> numArgs</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ValidatePriority(priority, <span class="string">"priority"</span>);</span><br><span class="line">    <span class="keyword">if</span>(method == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"method"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    DispatcherOperation operation = <span class="keyword">new</span> DispatcherOperation(<span class="keyword">this</span>, method, priority, args, numArgs);</span><br><span class="line">    InvokeAsyncImpl(operation, CancellationToken.None);</span><br><span class="line">    <span class="keyword">return</span> operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And its name’s prefix <code>Legacy</code> gives us some information about Microsoft’s altitude this method. It probably means Microsoft does not want to maintain this code anymore. Maybe, a few years later it will be marked as an <code>Obsolete</code> method.</p>
<p>Here is the code of <code>InvokeAsync</code> method.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">InvokeAsync</span>(<span class="params">Action callback</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">InvokeAsync</span>(<span class="params">Action callback, DispatcherPriority priority</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">SecuritySafeCritical</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">InvokeAsync</span>(<span class="params">Action callback, DispatcherPriority priority, CancellationToken cancellationToken</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DispatcherOperation&lt;TResult&gt; InvokeAsync&lt;TResult&gt;(Func&lt;TResult&gt; callback);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DispatcherOperation&lt;TResult&gt; InvokeAsync&lt;TResult&gt;(Func&lt;TResult&gt; callback, DispatcherPriority priority);</span><br><span class="line"></span><br><span class="line">[<span class="meta">SecuritySafeCritical</span>]</span><br><span class="line"><span class="keyword">public</span> DispatcherOperation&lt;TResult&gt; InvokeAsync&lt;TResult&gt;(Func&lt;TResult&gt; callback, DispatcherPriority priority, CancellationToken cancellationToken);</span><br></pre></td></tr></table></figure>
<p>This is what the TAP code looks like. After reading these method’s code we can find that the implementation of these methods is almost the same. Here, I post the third method’s source code.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SecuritySafeCritical</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperation <span class="title">InvokeAsync</span>(<span class="params">Action callback, DispatcherPriority priority, CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(callback == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"callback"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ValidatePriority(priority, <span class="string">"priority"</span>);</span><br><span class="line">    DispatcherOperation operation = <span class="keyword">new</span> DispatcherOperation(<span class="keyword">this</span>, priority, callback);</span><br><span class="line">    InvokeAsyncImpl(operation, cancellationToken);</span><br><span class="line">    <span class="keyword">return</span> operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What is the feeling when you read these codes? Yeah, there must be a voice in your mind and it says that ‘I read them before’. They are almost the same as <code>LegacyBeginInvokeImpl</code>.</p>
<p>Finally, we knew the answer to why Microsoft recommended <code>InvokeAsync</code> instead of <code>BeginInvoke</code>. Microsoft had changed <code>BeginInvoke</code>‘s implementation to <em>TAP</em> model but didn’t change its name and the parameters list in <code>NET Framework 4.5</code>. So, they added another six methods(<code>InvokeAsync</code>), and these all methods above do the same thing.</p>
<p>Due to <code>InvokeAsync</code> and <code>BeginInvoke</code> has the same codes, we don’t have to introduce both methods. So, in the following paragraphs, we are going to introduce more details about <code>InvokeAsync</code>.</p>
<hr>
<h3 id="Thoery-of-InvokeAsync"><a href="#Thoery-of-InvokeAsync" class="headerlink" title="Thoery of InvokeAsync"></a>Thoery of <code>InvokeAsync</code></h3><p>All information above told us that the core of the <code>InvokeAsync</code> method is <code>InvokeAsyncImpl</code>. Here are the steps of the <code>InvokeAsync</code> method.</p>
<ol>
<li><p>Wrap the <code>Action/Func</code> with <code>DispatcherOperation</code>.Therefore, the task  and priority we passed will be processed together;</p>
</li>
<li><p>Add <code>DispatcherOperation</code> to a queue of <code>PriorityQueue&lt;DispatcherOperation&gt;</code>. This queue implements a <code>SortedList</code> class, every time it pops a task is depending on its priority. </p>
</li>
<li><p>Call <code>RequestProcessing</code>, send a message to a <strong>hidden window</strong> at last.</p>
</li>
<li><p>When the <strong>hidden window</strong> received that message, it will take a task from the <code>PriorityQueue</code> and execute it. (The real situation is more complicated, all details will be shown below).</p>
</li>
</ol>
<p><img src="/2019/05/16/Learn-more-about-how-WPF-Dispatcher-works-Invoke-and-InvokeAsync/2019-5-19-1.png" alt></p>
<p>In this progress, it calls <code>TryPostMessage</code> to send messages. Here is the method’s code.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UnsafeNativeMethods.TryPostMessage(<span class="keyword">new</span> HandleRef(<span class="keyword">this</span>, _window.Value.Handle), _msgProcessQueue, IntPtr.Zero, IntPtr.Zero);</span><br></pre></td></tr></table></figure>
<p>It is important to notice that there is a <code>_window</code>, but what does this <code>_window</code> mean? After reading the constructor of the <code>Dispatcher</code> class, we found this <code>_window</code>. It is not the <code>Window</code> class we usually know, it a hidden window of <code>Win32</code>, and its usage is to send and receive the schedule message of the <code>Dispatcher</code> class. For more details about this window, visit <code>MessageOnlyHwndWrapper</code>‘s source code, and you will find it calls <code>UnsafeNativeMethods.CreateWindowEx</code> method to create this window in its base class <code>HwndWrapper</code>.</p>
<p>Since it can send a message to <code>_window</code>, it is natural to <code>Hook</code> its message handler, like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the message-only window we use to receive messages</span></span><br><span class="line"><span class="comment">// that tell us to process the queue.</span></span><br><span class="line">MessageOnlyHwndWrapper window = <span class="keyword">new</span> MessageOnlyHwndWrapper();</span><br><span class="line">_window = <span class="keyword">new</span> SecurityCriticalData&lt;MessageOnlyHwndWrapper&gt;( window );</span><br><span class="line"></span><br><span class="line">_hook = <span class="keyword">new</span> HwndWrapperHook(WndProcHook);</span><br><span class="line">_window.Value.AddHook(_hook);</span><br></pre></td></tr></table></figure>
<p>In this <code>WndProcHook</code> method, it handles three types of messages.</p>
<ol>
<li>Close the hidden window (<code>_window</code>).</li>
<li>Handle the scheduled task of the <code>Dispatcher</code> class (this message is registered at the static constructor method of <code>Dispatcher</code>).</li>
<li>Timer.</li>
</ol>
<p>Why does it handle the message about the timer?</p>
<p>After researching, it is clear that Microsoft split all priorities into three types.</p>
<ol>
<li>Foreground priority (from <code>DispatcherPriority.Loaded</code> to <code>DispatcherPriority.Send</code>, the number is 6 to 10).</li>
<li>Background priority (from <code>DispatcherPriority.Background</code> to <code>DispatcherPriority.Send</code>, the number is 4 to 5).</li>
<li>Idle priority (from <code>DispatcherPriority.SystemIdle</code> to <code>DispatcherPriority.ApplicationIdle</code>, the number is 1 to 3)</li>
</ol>
<p>But, it needs to notice that the <code>Background priority</code> and <code>Idle priority</code> are treated as one type of priority in Microsoft’s code. So, in fact, there are just two types of priority, the <code>Foreground</code> and <code>Background</code>. And there is one point to distinguish them is <em>user’s input</em>.</p>
<p>If a user’s input occurs, a timer will be turned on, and during this time interval, all <code>Background priority</code> tasks will not be executed.  But <code>Foreground priority</code> tasks will not be affected by the user’s inputs. Therefore, the user’s inputs will not be starved, and the WPF application will not be stuck from the input level.</p>
<p>It’s important to notice that <code>InvokeAsync</code> is implemented according to the <code>TAP</code> asynchronous model, and this method can be used with <code>await</code>. How does it work?</p>
<p>After reading the source code of <code>InvokeAsync</code> which is posted above, we noticed that the return value of the <code>InvokeAsync</code> method is an instance of <code>DispatcherOperation</code>. This instance is created at the beginning of the codes. <code>DispatcherOperation operation = new DispatcherOperation(this, priority, callback);</code> There is an <code>Invoke</code> method without a return value, but it will change the result of <code>Task</code>. And the <code>DispatcherOperation</code> class has implemented the <code>GetAwaiter</code> method so we can use <code>await</code> before this method. </p>
<p>For more information about <code>await</code>, see <a href="https://blogs.msdn.microsoft.com/lucian/2012/12/11/how-to-write-a-custom-awaiter/" target="_blank" rel="noopener">How to write a custom awaiter – Lucian’s VBlog</a>.</p>
<h3 id="The-theory-of-Invoke"><a href="#The-theory-of-Invoke" class="headerlink" title="The theory of Invoke"></a>The theory of <code>Invoke</code></h3><p>If you think the theory of <code>Invoke</code> is easier than <code>InvokeAsync</code>, probably you may ignore a very import question - <code>deadlock</code>. If the <code>Invoke</code> implemented according to the <code>Synchronous wait</code> method, the UI thread will be blocked when it calls the <code>Invoke</code> method on the current thread. And the <code>Action</code> passed by <code>Invoke</code> method will be executed on UI thread, but this thread is blocked, so <code>deadlock</code> happens.</p>
<p>To avoid <code>deadlock</code>, <code>Invoke</code> method must have other implementation, and there are two branches for this implementation developed by Microsoft.</p>
<ol>
<li><p>If the task’s priority is the highest priority (the number is 10), it will call the <code>action</code> passed by <code>Invoke</code> method.</p>
</li>
<li><p>If the task’s priority is lower than 10, it will call <code>DispatcherOperation.Wait</code> method to wait.</p>
</li>
</ol>
<p>Here is a part of the source code of <code>DispatcherOperation.Wait</code> method.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DispatcherOperationStatus <span class="title">Wait</span>(<span class="params">TimeSpan timeout</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Previous codes are omitted</span></span><br><span class="line">            </span><br><span class="line">    <span class="comment">// We are the dispatching thread for this operation, so</span></span><br><span class="line">    <span class="comment">// we can't block.  We will push a frame instead.</span></span><br><span class="line">    DispatcherOperationFrame frame = <span class="keyword">new</span> DispatcherOperationFrame(<span class="keyword">this</span>, timeout);</span><br><span class="line">    Dispatcher.PushFrame(frame);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// Behind codes are omitted</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this method above, it calls <code>Dispatcher.PushFrame</code>, and this method can wait without blocking the thread. For more theories visit <a href="https://blog.walterlv.com/post/dotnet/2017/09/26/dispatcher-push-frame.html" target="_blank" rel="noopener">深入了解 WPF Dispatcher 的工作原理（PushFrame 部分）</a>.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><ol>
<li>We recommended using <code>InvokeAsync</code> instead of <code>BeginInvoke</code> if your application’s framework version is higher than 4.5.</li>
<li><code>Dispatcher</code> execute all <code>Invoke</code> tasks by priority by creating a hidden message window.</li>
<li><code>Invoke</code> method avoids blocking UI thread by the <code>PushFrame</code> method.</li>
</ol>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li>Asynchronous model<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/asynchronous-programming-model-apm?wt.mc_id=MVP" target="_blank" rel="noopener">Asynchronous Programming Model (APM) - Microsoft Docs</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/aa719595(v=vs.71" target="_blank" rel="noopener">Asynchronous Design Pattern Overview</a>.aspx)</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/interop-with-other-asynchronous-patterns-and-types?wt.mc_id=MVP" target="_blank" rel="noopener">Interop with Other Asynchronous Patterns and Types - Microsoft Docs</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/task-based-asynchronous-pattern-tap?wt.mc_id=MVP" target="_blank" rel="noopener">Task-based Asynchronous Pattern (TAP) - Microsoft Docs</a></li>
</ul>
</li>
<li>InvokeAsync<ul>
<li><a href="http://referencesource.microsoft.com/#WindowsBase/Base/System/Windows/Threading/Dispatcher.cs" target="_blank" rel="noopener">Dispatcher.cs</a></li>
</ul>
</li>
<li>WPF message mechanism<ul>
<li><a href="http://blog.csdn.net/powertoolsteam/article/details/6109036" target="_blank" rel="noopener">WPF的消息机制（二）- WPF内部的5个窗口之隐藏消息窗口 - 葡萄城控件技术团队博客 - CSDN博客</a></li>
</ul>
</li>
<li>Awaiter<ul>
<li><a href="https://blogs.msdn.microsoft.com/lucian/2012/12/11/how-to-write-a-custom-awaiter/" target="_blank" rel="noopener">How to write a custom awaiter – Lucian’s VBlog</a></li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/15/transfer-of-execution-rights-Task-Yield-Dispatcher-Yield/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Neal chen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/badboy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Neal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/15/transfer-of-execution-rights-Task-Yield-Dispatcher-Yield/" itemprop="url">Transfer of execution rights - Task.Yield, Dispatcher.Yield</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-15T20:18:40-06:00">
                2019-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>As the word <code>Yield</code> means, the <code>Yield()</code> method transfers the execution right of the current task, after that other tasks may get the right to execute. And the method of <code>Yield()</code> is existed in <code>Task</code>, <code>Dispatcher</code>, <code>Thread</code> class, and as the name shows, all of these methods are to transfer the current task’s execution right. </p>
<p>Are there any differences? How do they work?</p>
<p>In this article, we will see more details about the <code>Yield()</code> methods.</p>
<h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><blockquote>
<p>The original link is <a href="https://blog.walterlv.com/post/yield-in-task-dispatcher.html" target="_blank" rel="noopener">出让执行权：Task.Yield, Dispatcher.Yield</a>. But this blog was written in Chinese, so I translate its content to English. Waterlv is an MVP(Microsoft Most Valuable Professional), and he is good at .NET Core\WPF\.NET. Here is his <a href="https://blog.walterlv.com/" target="_blank" rel="noopener">Blog</a>.</p>
</blockquote>
<hr>
<h3 id="Dispatcher-Yield"><a href="#Dispatcher-Yield" class="headerlink" title="Dispatcher.Yield"></a>Dispatcher.Yield</h3><p>If we have to implement a time-consuming method,  what methods or <code>API</code> will you choose to avoid affecting the <code>UI</code> thread? Maybe <code>Invoke</code> and <code>InvokeAsync</code> is a good choice, they split the time-consuming task into small pieces that are executed at a lower priority than user input and rendering.</p>
<p> <code>Dispatcher.Yield()</code> does the same job, and its function is more familiar with <code>Dispatcher.InvokeAsync</code> than <code>Dispatcher.Invoke</code>.</p>
<p> It needs <code>await</code> before the method when we use it.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> item <span class="keyword">in</span> collection)</span><br><span class="line">&#123;</span><br><span class="line">    DoWorkWhichWillTakeHalfASecond();</span><br><span class="line">    <span class="keyword">await</span> Dispacther.Yield();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As the codes above, it splits the task to small pieces every time when executing <code>foreach</code> method. Therefore, the <code>UI</code> thread can respond to user interaction and rendering when running these time-consuming codes.</p>
<p>We can pass a parameter to <code>Yield</code> method when we use it, the value of this parameter is the priority of the subsequent task. Its default value is <code>DispatcherPriority.Background</code>, and priority of <code>Background</code> is lower than the user’s input action’s priority (<code>DispatcherPrority.Input</code>), UI’s priority (<code>DispatcherPriority.Loaded</code>) and rendering priority (<code>DispatcherPriority.Render</code>).</p>
<p>How does <code>Dispatcher.Yield</code> method work?</p>
<p>After reading the source codes of <code>Dispatcher.Yield</code>, it can find that the result of this method is an instance of <code>DispatcherPriorityAwaiter</code>, and its <code>OnCompleted</code> method is posted below.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCompleted</span>(<span class="params">Action continuation</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(_dispatcher == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(SR.Get(SRID.DispatcherPriorityAwaiterInvalid));</span><br><span class="line">    _dispatcher.InvokeAsync(continuation, _priority);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can find that this <code>OnCompleted</code> method calls the <code>InvokeAsync</code> method. It depends on <code>InvokeAsync</code> to implement its function. </p>
<p>Visit <a href="http://liujiajia.me/blog/details/csharp-multi-threading-05-csharp6-08-customize-awaitable" target="_blank" rel="noopener">【C#】【多线程】【05-使用C#6.0】08-自定义awaitable类型 - L.M</a>, for more information about <code>OnCompleted</code> method.</p>
<h4 id="Tips-about-Dispatcher-Yield"><a href="#Tips-about-Dispatcher-Yield" class="headerlink" title="Tips about Dispatcher.Yield()"></a>Tips about <code>Dispatcher.Yield()</code></h4><p><code>Dispatcher.Yield</code> is a <strong>static</strong> method of class <code>Dispatcher</code>, and <code>InvokeAsync</code> is a normal method.<br>Here is an example.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Windows.Threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Demo</span> : <span class="title">DispatcherObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// this 'Dispatcher' is class and Yield() is a static method of Dispatcher class.</span></span><br><span class="line">        <span class="keyword">await</span> Dispatcher.Yield();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// this 'Dispatcher' is an instance of 'Dispatcher' class, and the name of this instance is Dispatcher.</span></span><br><span class="line">        <span class="keyword">await</span> Dispatcher.InvokeAsync(()=&gt;&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Task-Yield"><a href="#Task-Yield" class="headerlink" title="Task.Yield"></a>Task.Yield</h3><p>We use <code>Task.Yield</code> method instead of <code>Dispatcher.Yield</code> in the example posted above.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> item <span class="keyword">in</span> collection)</span><br><span class="line">&#123;</span><br><span class="line">    DoWorkWhichWillTakeHalfASecond();</span><br><span class="line">    <span class="keyword">await</span> Task.Yield();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This method has the same effect as <code>Dispatcher.Yield(DispatcherPriority.Normal)</code>. <code>Task</code> depends on <code>SynchronizationContext</code> to schedule threads, and the WPF UI thread’s <code>SynchronizationContext</code> is set to <code>DispatcherSynchronizationContext</code>, it relies <code>Dispatcher</code> to schedule; When creating an instance of <code>DispatcherSynchronizationContext</code> its default priority is <code>Normal</code>, and WPF doesn’t pass a special value. So, after calling <code>Task.Yield</code> on WPF UI thread to transfer execution right, it uses <code>Normal</code> priority to recover. Therefore, its effect is the same as <code>Dispatcher.Yield(DispatcherPriority.Normal)</code>.</p>
<p>Here is the code about how does <code>DispatcherSynchronizationContext</code> execute subsequent task.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     Asynchronously invoke the callback in the SynchronizationContext.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Post</span>(<span class="params">SendOrPostCallback d, Object state</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Call BeginInvoke with the cached priority.  Note that BeginInvoke</span></span><br><span class="line">    <span class="comment">// preserves the behavior of passing exceptions to</span></span><br><span class="line">    <span class="comment">// Dispatcher.UnhandledException unlike InvokeAsync.  This is</span></span><br><span class="line">    <span class="comment">// desireable because there is no way to await the call to Post, so</span></span><br><span class="line">    <span class="comment">// exceptions are hard to observe.</span></span><br><span class="line">    _dispatcher.BeginInvoke(_priority, d, state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Due to <code>Task.Yield</code>‘s <code>Normal</code> priority, its effect on the UI thread is not as good as <code>Dispatcher.Yield</code>. But, it is important to note that <code>SynchronizationContext</code> is not related to <code>Dispatcher</code>, so <code>Task.Yield</code> can be called on every thread. And it will be a good choice to use <code>Task.Yield</code> to split the time-consuming task into small tasks in the <code>Task</code> method.</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a href="chrome-extension://klbibkeccnjlkjkiokjodocebajanakg/suspended.html#ttl=c%23%20-%20Task.Yield%20-%20real%20usages%3F%20-%20Stack%20Overflow&amp;uri=https://stackoverflow.com/questions/23431595/task-yield-real-usages" target="_blank" rel="noopener">c# - Task.Yield - real usages? - Stack Overflow</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/system.threading.tasks.task.yield%28v=vs.110%29.aspx?f=255&amp;MSPPError=-2147217396" target="_blank" rel="noopener">Task.Yield Method (System.Threading.Tasks)</a></li>
<li><a href="https://stackoverflow.com/questions/24671883/difference-between-synchronization-context-and-dispatcher" target="_blank" rel="noopener">c# - Difference between Synchronization Context and Dispatcher - Stack Overflow</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/14/The-usages-and-suggestions-about-Thead-Sleep-0-Task-Delay-0-Thread-Yield-Task-Yield-functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Neal chen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/badboy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Neal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/14/The-usages-and-suggestions-about-Thead-Sleep-0-Task-Delay-0-Thread-Yield-Task-Yield-functions/" itemprop="url">The usages and suggestions about Thead.Sleep(0),Task.Delay(0),Thread.Yield(),Task.Yield()</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-14T18:44:07-06:00">
                2019-05-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>There are some methods to release current thread excution right in .NET/C#. They are <code>Thread.Sleep(0)</code>,<code>Task.Delay(0)</code>,<code>Thread.Yield()</code>,<code>Task.Yeild()</code>. The function of these methods is to tell the program to give up current thread and then run another thread. But there are some differences among these methods.</p>
<p>This article is about their differences and theories.</p>
<hr>
<h3 id="Detail"><a href="#Detail" class="headerlink" title="Detail"></a>Detail</h3><blockquote>
<p>The original link is <a href="https://blog.walterlv.com/post/sleep-delay-zero-vs-yield.html" target="_blank" rel="noopener">C#/.NET 中 Thread.Sleep(0), Task.Delay(0), Thread.Yield(), Task.Yield() 不同的执行效果和用法建议</a>. But this blog was written in Chinese, so I translate its content to English. Waterlv is an MVP(Microsoft Most Valuable Professional), and he is good at .NET Core\WPF\.NET. Here is his <a href="https://blog.walterlv.com/" target="_blank" rel="noopener">Blog</a>.</p>
</blockquote>
<hr>
<h3 id="Theories"><a href="#Theories" class="headerlink" title="Theories"></a>Theories</h3><h4 id="Thread-Sleep-0"><a href="#Thread-Sleep-0" class="headerlink" title="Thread.Sleep(0)"></a>Thread.Sleep(0)</h4><p>Firstly,I will post the source code of <code>Thread.Spleep(int millisecondsTimeout)</code>.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*=========================================================================</span></span><br><span class="line"><span class="comment">** Suspends the current thread for timeout milliseconds. If timeout == 0,</span></span><br><span class="line"><span class="comment">** forces the thread to give up the remainer of its timeslice.  If timeout</span></span><br><span class="line"><span class="comment">** == Timeout.Infinite, no timeout will occur.</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** Exceptions: ArgumentException if timeout &lt; 0.</span></span><br><span class="line"><span class="comment">**             ThreadInterruptedException if the thread is interrupted while sleeping.</span></span><br><span class="line"><span class="comment">=========================================================================*/</span></span><br><span class="line">[<span class="meta">System.Security.SecurityCritical</span>]  <span class="comment">// auto-generated</span></span><br><span class="line">[<span class="meta">ResourceExposure(ResourceScope.None)</span>]</span><br><span class="line">[<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">SleepInternal</span>(<span class="params"><span class="keyword">int</span> millisecondsTimeout</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">System.Security.SecuritySafeCritical</span>]  <span class="comment">// auto-generated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Sleep</span>(<span class="params"><span class="keyword">int</span> millisecondsTimeout</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SleepInternal(millisecondsTimeout);</span><br><span class="line">    <span class="comment">// Ensure we don't return to app code when the pause is underway</span></span><br><span class="line">    <span class="keyword">if</span>(AppDomainPauseManager.IsPaused)</span><br><span class="line">        AppDomainPauseManager.ResumeEvent.WaitOneWithoutFAS();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>It is easy to find that in the <code>Sleep</code> method it calls another method which’s name is <code>SleepInternal</code>. <code>SleepInternal</code> is implemented in <em>CLR</em>, and its function is suspending the current thread for the value of <code>millisecondsTimeout</code>.</p>
<p>If we set the value of <code>milliseconsTimeout</code> to 0 as <code>Thread.Sleep(0)</code>.It will force the current thread to give up the rest of the <em>CPU</em> time slice. Then other threads which have higher priority will run. But if there are not any available threads have higher priority than current thread, this thread will keep running.</p>
<p>If your method will not be affected by other threads, there are not any differences among the methods above. But when your method is affected by multiple threads, other threads may run into this method when you call <code>Thread.Sleep(0)</code>.But it is good news that the <em>CPU</em> time slice for a thread is nanosecond level, so this situation is almost impossible to happen.</p>
<h4 id="Thread-Yeild"><a href="#Thread-Yeild" class="headerlink" title="Thread.Yeild()"></a>Thread.Yeild()</h4><p>Here is the code of <code>Thread.Yeild()</code><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">System.Security.SecurityCritical</span>]  <span class="comment">// auto-generated</span></span><br><span class="line">[<span class="meta">ResourceExposure(ResourceScope.None)</span>]</span><br><span class="line">[<span class="meta">DllImport(JitHelpers.QCall, CharSet = CharSet.Unicode)</span>]</span><br><span class="line">[<span class="meta">SuppressUnmanagedCodeSecurity</span>]</span><br><span class="line">[<span class="meta">HostProtection(Synchronization = true, ExternalThreading = true),</span></span><br><span class="line"><span class="meta">    ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">YieldInternal</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">System.Security.SecuritySafeCritical</span>]  <span class="comment">// auto-generated</span></span><br><span class="line">[<span class="meta">HostProtection(Synchronization = true, ExternalThreading = true),</span></span><br><span class="line"><span class="meta">    ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">Yield</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> YieldInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>And we can notice that <code>Yield()</code> method calls <code>YieldInternal()</code> method. And <code>YieldInternal</code> is implemented in <em>CLR</em> too.</p>
<p>The function of <code>Thread.Yield()</code> is to force the current thread to give up the rest of <em>CPU</em> time slice, the same as <code>Thread.Sleep(0)</code>.</p>
<h4 id="Thread-Sleep-1"><a href="#Thread-Sleep-1" class="headerlink" title="Thread.Sleep(1)"></a>Thread.Sleep(1)</h4><p>It is just a little differance between <code>Thread.Sleep(1)</code> and <code>Thread.Sleep(0)</code>, but their function are different.</p>
<p>The current thread will be suspended for timeout milliseconds(here is 1ms). Therefore, during timeout milliseconds current thread will stay at the un-schedulable state. So, other threads will be run even their priority is lower than the current thread.</p>
<p>Here is the result of these three method’s execution time.<br><img src="/2019/05/14/The-usages-and-suggestions-about-Thead-Sleep-0-Task-Delay-0-Thread-Yield-Task-Yield-functions/2018-11-27-11-10-43.png" alt></p>
<p><code>Nothing</code> means there are not any codes. And we used <code>Stopwatch</code> to get the result. For more detail about <code>Stopwatch</code> visit <a href="https://blog.walterlv.com/post/dotnet-high-precision-performance-counting.html" target="_blank" rel="noopener">.NET/C# 在代码中测量代码执行耗时的建议（比较系统性能计数器和系统时间）</a>. This blog was written in Chinese, I will translate it later.<br>Here is a part of the codes.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stopwatch = Stopwatch.StartNew();</span><br><span class="line">Thread.Sleep(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">var</span> elapsed = stopwatch.Elapsed;</span><br><span class="line">Console.WriteLine(<span class="string">$"Thread.Sleep(0) : <span class="subst">&#123;elapsed&#125;</span>"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Task-Delay-0"><a href="#Task-Delay-0" class="headerlink" title="Task.Delay(0)"></a>Task.Delay(0)</h4><p><code>Task.Delay</code> is a method of <em>TAP</em>. For more informations about <em>TAP</em>,visit <a href="https://docs.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/task-based-asynchronous-pattern-tap?wt.mc_id=MVP" target="_blank" rel="noopener">Task-based Asynchronous Pattern (TAP) Microsoft Docs</a>.</p>
<p><em>TAP</em> is a threading model which bases on an async state machine, and this is the biggest difference from the <code>Thread</code> method.</p>
<p>Here is the source code of <code>Task.Delay</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates a Task that will complete after a time delay.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="millisecondsDelay"&gt;</span>The number of milliseconds to wait before completing the returned Task<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="cancellationToken"&gt;</span>The cancellation token that will be checked prior to completing the returned Task<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>A Task that represents the time delay<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref="T:System.ArgumentOutOfRangeException"&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The <span class="doctag">&lt;paramref name="millisecondsDelay"/&gt;</span> is less than -1.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref="T:System.ObjectDisposedException"&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The provided <span class="doctag">&lt;paramref name="cancellationToken"/&gt;</span> has already been disposed.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/exception&gt;</span>        </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> If the cancellation token is signaled before the specified time delay, then the Task is completed in</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Canceled state.  Otherwise, the Task is completed in RanToCompletion state once the specified time</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> delay has expired.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span>        </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Task <span class="title">Delay</span>(<span class="params"><span class="keyword">int</span> millisecondsDelay, CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Throw on non-sensical time</span></span><br><span class="line">    <span class="keyword">if</span> (millisecondsDelay &lt; <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">"millisecondsDelay"</span>, Environment.GetResourceString(<span class="string">"Task_Delay_InvalidMillisecondsDelay"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    Contract.EndContractBlock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// some short-cuts in case quick completion is in order</span></span><br><span class="line">    <span class="keyword">if</span> (cancellationToken.IsCancellationRequested)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// return a Task created as already-Canceled</span></span><br><span class="line">        <span class="keyword">return</span> Task.FromCancellation(cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (millisecondsDelay == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// return a Task created as already-RanToCompletion</span></span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct a promise-style Task to encapsulate our return value</span></span><br><span class="line">    <span class="keyword">var</span> promise = <span class="keyword">new</span> DelayPromise(cancellationToken);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register our cancellation token, if necessary.</span></span><br><span class="line">    <span class="keyword">if</span> (cancellationToken.CanBeCanceled)</span><br><span class="line">    &#123;</span><br><span class="line">        promise.Registration = cancellationToken.InternalRegisterWithoutEC(state =&gt; ((DelayPromise)state).Complete(), promise);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... and create our timer and make sure that it stays rooted.</span></span><br><span class="line">    <span class="keyword">if</span> (millisecondsDelay != Timeout.Infinite) <span class="comment">// no need to create the timer if it's an infinite timeout</span></span><br><span class="line">    &#123;</span><br><span class="line">        promise.Timer = <span class="keyword">new</span> Timer(state =&gt; ((DelayPromise)state).Complete(), promise, millisecondsDelay, Timeout.Infinite);</span><br><span class="line">        promise.Timer.KeepRootedWhileScheduled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the timer proxy task</span></span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This method will return <code>Task.CompleteTask</code> as a result when the value of the parameter is <code>0</code>. That means the code you write after <code>Task.Delay(0)</code> will be executed immediately. (If the rest of <em>CPU</em> time slice is enough).</p>
<h4 id="Task-Yield"><a href="#Task-Yield" class="headerlink" title="Task.Yield()"></a>Task.Yield()</h4><p>The result of <code>Task.Yield()</code> is a <code>YeildAwaitable</code> instance and the <code>YieldAwaitable.GetAwaiter</code> method returns an instance of <code>YieldAwaiter</code>. So, the result of <code>Task.Yield</code> method is fully depending on <code>YieldAwaiter</code>. For more details about <code>Awaiter</code> visit <a href="https://blog.walterlv.com/post/write-custom-awaiter.html" target="_blank" rel="noopener">如何实现一个可以用 await 异步等待的 Awaiter</a>.</p>
<p><code>YieldAwaiter</code> relies on <code>QueueContinuation</code> to determine when to execute subsequent codes. Part of the source codes is listed below.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the current SynchronizationContext, and if there is one,</span></span><br><span class="line"><span class="comment">// post the continuation to it.  However, treat the base type</span></span><br><span class="line"><span class="comment">// as if there wasn't a SynchronizationContext, since that's what it</span></span><br><span class="line"><span class="comment">// logically represents.</span></span><br><span class="line"><span class="keyword">var</span> syncCtx = SynchronizationContext.CurrentNoFlow;</span><br><span class="line"><span class="keyword">if</span> (syncCtx != <span class="literal">null</span> &amp;&amp; syncCtx.GetType() != <span class="keyword">typeof</span>(SynchronizationContext))</span><br><span class="line">&#123;</span><br><span class="line">    syncCtx.Post(s_sendOrPostCallbackRunAction, continuation);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// If we're targeting the default scheduler, queue to the thread pool, so that we go into the global</span></span><br><span class="line">    <span class="comment">// queue.  As we're going into the global queue, we might as well use QUWI, which for the global queue is</span></span><br><span class="line">    <span class="comment">// just a tad faster than task, due to a smaller object getting allocated and less work on the execution path.</span></span><br><span class="line">    TaskScheduler scheduler = TaskScheduler.Current;</span><br><span class="line">    <span class="keyword">if</span> (scheduler == TaskScheduler.Default)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (flowContext)</span><br><span class="line">        &#123;</span><br><span class="line">            ThreadPool.QueueUserWorkItem(s_waitCallbackRunAction, continuation);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ThreadPool.UnsafeQueueUserWorkItem(s_waitCallbackRunAction, continuation);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We're targeting a custom scheduler, so queue a task.</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Task.Factory.StartNew(continuation, <span class="keyword">default</span>(CancellationToken), TaskCreationOptions.PreferFairness, scheduler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There are two branches in these codes.</p>
<ol>
<li><p>One is setting <code>DispatcherSynchronizationContext</code> as the value of <code>SynchronizationContext</code> , then it will call <code>Post</code> method in <code>SynchronizationContext</code> to execute next asynchronous task. The ‘continuation’ means executes the next asynchronous task.<br>The value of <code>SynchronizationContext</code> is set as <code>DispatcherSynchronizationContext</code> for WPF UI thread, and its <code>Post</code> method is designed to implement the message loop. If other threads have no special setting, the value of <code>SynchronizationContext</code> is always <code>null</code>. For more information,see <a href="https://blog.walterlv.com/post/yield-in-task-dispatcher.html" target="_blank" rel="noopener">出让执行权：Task.Yield, Dispatcher.Yield</a>.</p>
</li>
<li><p>If the value of <code>DispacherSynchronizationContext</code> is <code>null</code> or <code>SynchronizationContext</code> type, the codes above will run <code>else</code> logic. And its logic is depending on the value of <code>TaskScheduler.Current</code>, it will find next thread in thread pool or start a <code>Task</code> again.</p>
</li>
</ol>
<h4 id="Task-Delay-1"><a href="#Task-Delay-1" class="headerlink" title="Task.Delay(1)"></a>Task.Delay(1)</h4><p><code>Task.Delay(1)</code> is almost the same as <code>Task.Delay(0)</code>, but the function of these two codes is different.</p>
<p><code>Task.Delay(1)</code> starts a <code>System.Threading.Timer</code> instance, and it will describe a callback method which is executed when time is up.</p>
<p>Here is the exact API order to excute the callback</p>
<blockquote>
<p> <code>Timer.TimerSetup</code>-&gt;<code>TimerHolder</code>-&gt;<code>TimerQueueTimer</code>-&gt;<code>TimerQueue.UpdateTimer</code>-&gt;<code>EnsureAppDomainTimerFiresBy</code>-&gt;<code>ChangeAppDomainTimer</code>-&gt;<code>callback</code></p>
</blockquote>
<p>The codes after <code>await</code> will be encapsulated by the asynchronous state machine and passed to the callback above.</p>
<p>Here is the code of <code>ChangeAppDomainTimer</code> method.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">System.Security.SecurityCritical</span>]</span><br><span class="line">[<span class="meta">ResourceExposure(ResourceScope.None)</span>]</span><br><span class="line">[<span class="meta">DllImport(JitHelpers.QCall, CharSet = CharSet.Unicode)</span>]</span><br><span class="line">[<span class="meta">SuppressUnmanagedCodeSecurity</span>]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">ChangeAppDomainTimer</span>(<span class="params">AppDomainTimerSafeHandle handle, <span class="keyword">uint</span> dueTime</span>)</span>;</span><br></pre></td></tr></table></figure></p>
<p>And when we call the methods in <code>Thread</code>, they just affect the scheduling status of the current thread. But when we call the methods in <code>Task</code>, they will affect the scheduling of the thread pool, then they will call <code>System.Threading.Timer</code> to count time, the time they consume is more uncontrollable.</p>
<p>Here is the result of the time they consumed.<br><img src="/2019/05/14/The-usages-and-suggestions-about-Thead-Sleep-0-Task-Delay-0-Thread-Yield-Task-Yield-functions/2018-11-27-12-51-30.png" alt></p>
<p><code>Nothing</code> means there are not any codes.</p>
<h3 id="Differences"><a href="#Differences" class="headerlink" title="Differences"></a>Differences</h3><p>The function of <code>Thread.Sleep(0)</code> and <code>Thread.Yield()</code> is the same in thread scheduling. And <code>Thread.Sleep(int)</code> will wait for time out and it bases on <code>thread scheduling</code>. </p>
<p><code>Thread.Sleep(0)</code> and <code>Thread.Yield()</code> can be called for giving up current thread’s rest time slice, and give chance to run other threads. If you want to make your thread wait, you can call <code>Thread.Sleep(int)</code>.</p>
<p>If you have to use <code>async/await</code> , you should use <code>Task.Delay(0)</code> or <code>Task.Yield()</code>. If you use <code>Task.Delay</code> instead of <code>Thread.Sleep</code>, it can save resources for one thread.</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a href="http://www.cnblogs.com/stg609/p/3857242.html" target="_blank" rel="noopener">Thread.Sleep(0) vs Sleep(1) vs Yeild - stg609 - 博客园</a></li>
<li><a href="https://stackoverflow.com/q/41830216/6233938" target="_blank" rel="noopener">c# - Task.Delay().Wait(); sometimes causing a 15ms delay in messaging system - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/q/20082221/6233938" target="_blank" rel="noopener">c# - When to use Task.Delay, when to use Thread.Sleep? - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/q/29356139/6233938" target="_blank" rel="noopener">c# - Should I always use Task.Delay instead of Thread.Sleep? - Stack Overflow</a></li>
<li><a href="https://social.msdn.microsoft.com/Forums/en-US/d7071ba4-8962-43c6-975a-28cdbce51548/whats-the-difference-between-threadsleep0-and-threadyield?forum=csharplanguage" target="_blank" rel="noopener">What’s the difference between Thread.Sleep(0) and Thread,Yield()?</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/13/How-does-WPF-application-get-mouse-position-when-mouse-stay-outside-window/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Neal chen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/badboy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Neal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/13/How-does-WPF-application-get-mouse-position-when-mouse-stay-outside-window/" itemprop="url">How does WPF application get mouse position when the mouse is outside the window?</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-13T17:06:07-06:00">
                2019-05-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p>As we all know, we have two methods to get the mouse position which is relative to other controls. One is <code>Mouse.GetPosition(IInputElement relativeTo)</code> , the other is <code>MouseEventArgs.GetPosition(IInputElement relativeTo)</code>. But, what will we get when the mouse is outside the window’s client area? And how does it calculate?</p>
<p>This article is to tell developers about <em>what and how we get the mouse coordinate.</em></p>
<hr>
<h3 id="Detail"><a href="#Detail" class="headerlink" title="Detail"></a>Detail</h3><blockquote>
<p>The original link is <a href="https://blog.walterlv.com/post/wpf-mouse-position-when-mouse-is-out-of-window.html" title="source" target="_blank" rel="noopener">WPF 程序鼠标在窗口之外的时候，控件拿到的鼠标位置在哪里？ - walterlv</a>. But this blog was written in Chinese, so I translate its content to English. Waterlv is an MVP(Microsoft Most Valuable Professional), and he is good at .NET Core\WPF\.NET. Here is his <a href="https://blog.walterlv.com/" target="_blank" rel="noopener">Blog</a>.</p>
</blockquote>
<hr>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>Creates a default WPF application with Visual Studio 2019. And this application is developed with default .NET Core version, it contains a <code>Button</code> and <code>Textblock</code>. Now, we try to get mouse position relative to these two <code>FrameworkElement</code> with <code>Mouse.GetPosition</code> method. Here are the codes.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Input;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Media;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Walterlv.Demo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainWindow</span> : <span class="title">Window</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            InitializeComponent();</span><br><span class="line">            CompositionTarget.Rendering += OnRendering; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnRendering</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            DebugTextBlock.Text = Mouse.GetPosition(DebugTextBlock).ToString();</span><br><span class="line">            DebugButton.Content = Mouse.GetPosition(DebugButton).ToString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Observation"><a href="#Observation" class="headerlink" title="Observation"></a>Observation</h3><p>We ran this simple application, then we noticed that when the mouse is outside the window’s client area, the values of mouse position are exactly the same. See this .gif file below for more details.<br><img src="/2019/05/13/How-does-WPF-application-get-mouse-position-when-mouse-stay-outside-window/2019-04-30-mouse-get-position.gif" alt></p>
<p>For more information about <em>Client Area</em>, visit<br> <a href="https://blog.walterlv.com/post/wpf-simulate-native-window-style-using-window-chrome.html" target="_blank" rel="noopener">WPF 使用 WindowChrome，在自定义窗口标题栏的同时最大程度保留原生窗口样式（类似 UWP/Chrome）</a>.<br> This blog was written in Chinese. I will translate it later.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>We can get a conclusion from the messages applied above, the coordinate we get when the mouse is outside window client area is the screen’s left top position <code>(0,0)</code>.</p>
<p>We moved the window to the screen’s left top position to check our conclusion. And then we got the coordinate of outside mouse position, and the value is <code>(0,31)</code>.</p>
<blockquote>
<p>It should note that <code>31</code> is the height of the window’s title bar.</p>
</blockquote>
<p><img src="/2019/05/13/How-does-WPF-application-get-mouse-position-when-mouse-stay-outside-window/2019-04-30-14-41-36.png" alt></p>
<p>It shows that the conclusion is right. So, how does <code>GetPosition</code> work?</p>
<h3 id="Theory"><a href="#Theory" class="headerlink" title="Theory"></a>Theory</h3><p>After reading the source code of the <code>GetPosition</code> method. It is easy to find that it gets the coordinate depends on <code>ClientToScreen</code> API.<br>Here is the source codes.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SecurityCritical, SecurityTreatAsSafe</span>]</span><br><span class="line"><span class="function"><span class="keyword">internal</span> Point <span class="title">GetScreenPositionFromSystem</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Win32 has issues reliably returning where the mouse is.  Until we figure</span></span><br><span class="line">    <span class="comment">// out a better way, just return the last mouse position in screen coordinates.</span></span><br><span class="line"></span><br><span class="line">    Point ptScreen = <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Security Mitigation: do not give out input state if the device is not active.</span></span><br><span class="line">    <span class="keyword">if</span> (IsActive)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            PresentationSource activeSource = CriticalActiveSource;</span><br><span class="line">            <span class="keyword">if</span> (activeSource != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ptScreen = PointUtil.ClientToScreen(_lastPosition, activeSource);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (System.ComponentModel.Win32Exception)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// The window could be shutting down, so just return (0,0).</span></span><br><span class="line">            ptScreen = <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ptScreen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">SecurityCritical, SecurityTreatAsSafe</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Point <span class="title">ClientToScreen</span>(<span class="params">Point pointClient, PresentationSource presentationSource</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// For now we only know how to use HwndSource.</span></span><br><span class="line">    HwndSource inputSource = presentationSource <span class="keyword">as</span> HwndSource;</span><br><span class="line">    <span class="keyword">if</span>(inputSource == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> pointClient;</span><br><span class="line">    &#125;</span><br><span class="line">    HandleRef handleRef = <span class="keyword">new</span> HandleRef(inputSource, inputSource.CriticalHandle);</span><br><span class="line"></span><br><span class="line">    NativeMethods.POINT ptClient            = FromPoint(pointClient);</span><br><span class="line">    NativeMethods.POINT ptClientRTLAdjusted = AdjustForRightToLeft(ptClient, handleRef);</span><br><span class="line"></span><br><span class="line">    UnsafeNativeMethods.ClientToScreen(handleRef, ptClientRTLAdjusted);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ToPoint(ptClientRTLAdjusted);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And here is the definition of the <code>ClientToScreen</code> method in <code>user32.dll</code>.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">DllImport(<span class="meta-string">"user32.dll"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">ClientToScreen</span>(<span class="params">IntPtr hWnd, <span class="keyword">ref</span> Point lpPoint</span>)</span>;</span><br></pre></td></tr></table></figure></p>
<p>This method requires a window handle <code>hWnd</code> as a parameter,and its usage is listed below.</p>
<blockquote>
<p>A handle to the window whose client area is used for the conversion.</p>
</blockquote>
<p>Essentially, we use the <code>ClientToScreen</code> method to get the mouse’s coordinate. And  this method will return two different results:</p>
<blockquote>
<ul>
<li>If the function succeeds, the return value is nonzero.</li>
<li>If the function fails, the return value is zero.</li>
</ul>
</blockquote>
<p>So, this function fails when the mouse position is outside the window client area.And <code>ClientToScreen</code> returns (0,0) as result. Then, it will run the <code>ToPoint</code> method to translate the coordinate to relative control’s <em>coordinate system</em>. And that is the result we saw.</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a href="https://stackoverflow.com/a/4232281/6233938" target="_blank" rel="noopener">How do I get the current mouse screen coordinates in WPF? - Stack Overflow</a></li>
<li><a href="https://www.pinvoke.net/default.aspx/user32.clienttoscreen" target="_blank" rel="noopener">pinvoke.net: clienttoscreen (user32)</a></li>
<li><a href="https://stackoverflow.com/q/34534279/6233938" target="_blank" rel="noopener">c# - ClientToScreen unexpected return values? - Stack Overflow</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-clienttoscreen" target="_blank" rel="noopener">ClientToScreen function (winuser.h) - Microsoft Docs</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/12/Lesser-known-technologies-in-Xaml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Neal chen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/badboy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Neal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/12/Lesser-known-technologies-in-Xaml/" itemprop="url">Lesser known technologies in Xaml</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-12T16:11:13-06:00">
                2019-05-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="This-article-is-going-to-introduce-some-lesser-known-technologies-about-the-Xaml-file"><a href="#This-article-is-going-to-introduce-some-lesser-known-technologies-about-the-Xaml-file" class="headerlink" title="This article is going to introduce some lesser known technologies about the Xaml file."></a>This article is going to introduce some lesser known technologies about the Xaml file.</h4><hr>
<h3 id="Detail"><a href="#Detail" class="headerlink" title="Detail"></a>Detail</h3><blockquote>
<p>The original link is <a href="https://blog.walterlv.com/post/those-people-dont-know-about-xaml" target="_blank" rel="noopener">XAML 很少人知道的科技 - walterlv</a>. But this blog was written in Chinese, so I translate its content to English. Waterlv is an MVP(Microsoft Most Valuable Professional), and he is good at .NET Core\WPF\.NET. Here is his <a href="https://blog.walterlv.com/" target="_blank" rel="noopener">Blog</a>.</p>
</blockquote>
<hr>
<h3 id="The-value-of-Thickness-can-be-split-by-space"><a href="#The-value-of-Thickness-can-be-split-by-space" class="headerlink" title="The value of Thickness can be split by space."></a>The value of <code>Thickness</code> can be split by space.</h3><p>When we set the value of <code>FrameworkElement</code>‘s <code>Margin</code> property at Xaml designer, we always use a comma to split it. </p>
<p>But have you tried to use space to split the value of <code>Thickness</code> ?</p>
<p>Here is an example<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">Margin</span>=<span class="string">"10 12 0 0"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Set-multiple-values-of-enum-with-a-comma"><a href="#Set-multiple-values-of-enum-with-a-comma" class="headerlink" title="Set multiple values of enum with a comma(,)."></a>Set multiple values of enum with a comma(,).</h3><p>If an <code>enum</code> was marked <code>[Flags]</code> attribute, it can be set multiple values with bit operation.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Flags</span>]</span><br><span class="line"><span class="keyword">enum</span> NonClientFrameEdges</span><br><span class="line">&#123;</span><br><span class="line">    Left = <span class="number">0x001</span>,</span><br><span class="line">    Right = <span class="number">0x002</span>,</span><br><span class="line">    Top = <span class="number">0x003</span>,</span><br><span class="line">    Bottom = <span class="number">0x004</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>How to set the mutiple values of this <code>enum</code>? We can use <code>,</code> to fix this problem. Here is an example<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">WindowChrome</span> <span class="attr">NonClientFrameEdges</span>=<span class="string">"Left,Bottom,Right"</span> <span class="attr">GlassFrameThickness</span>=<span class="string">"0 64 0 0"</span> <span class="attr">UseAeroCaptionButtons</span>=<span class="string">"False"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Set-multiple-values-of-enum-with"><a href="#Set-multiple-values-of-enum-with" class="headerlink" title="Set multiple values of enum with +."></a>Set multiple values of <code>enum</code> with <code>+</code>.</h3><p>Usually, we use commas to set multiple values of <code>enum</code>.But, when we set the value of keyboard shortcuts in <code>WPF/UWP</code> , we use <code>+</code> instead of <code>,</code>.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">KeyBinding</span> <span class="attr">Command</span>=<span class="string">"&#123;x:Static WalterlvCommands.Foo&#125;"</span> <span class="attr">Modifiers</span>=<span class="string">"Control+Shift"</span> <span class="attr">Key</span>=<span class="string">"W"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>The type of <code>Modifiers</code> is <code>ModifierKeys</code>, and there is a special converter class that inherited <code>TypeConverter</code>. This class converts the value of <code>Modifiers</code> property (<code>string</code>) to <code>enum</code>. So, we use <code>+</code> to do bit operations for multiple values of keyboard shortcuts in Xaml.</p>
<h3 id="Set-value-of-XAML-namespace-with-the-type-of-Url"><a href="#Set-value-of-XAML-namespace-with-the-type-of-Url" class="headerlink" title="Set value of XAML namespace with the type of Url."></a>Set value of XAML namespace with the type of Url.</h3><p>The namespace of original controls in <code>WPF/UWP</code> is <a href="http://schemas.microsoft.com/winfx/2006/xaml/presentation" target="_blank" rel="noopener">http://schemas.microsoft.com/winfx/2006/xaml/presentation</a>; and the namespace of XAML’s designer is <a href="http://schemas.microsoft.com/winfx/2006/xaml" target="_blank" rel="noopener"> http://schemas.microsoft.com/winfx/2006/xaml</a>. There are many XAML namespaces which were named with Url.</p>
<p>We can set namespace name to Url type by adding an attribute above current namespace.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Windows.Markup;</span><br><span class="line">[<span class="meta">assembly: XmlnsDefinition(<span class="meta-string">"http://walterlv.github.io/demo"</span>, <span class="meta-string">"Walterlv.NewCsprojDemo"</span>)</span>]</span><br></pre></td></tr></table></figure></p>
<p>For more information, you can visit this blog:</p>
<p><a href="https://blog.walterlv.com/post/define-xmlns-of-for-xaml.html" target="_blank" rel="noopener">让你编写的控件库在 XAML 中有一个统一的漂亮的命名空间（xmlns）和命名空间前缀</a>. This blog was written in Chinese, I will translate it later.</p>
<h3 id="Set-default-value-of-namespace-prefix-in-XAML"><a href="#Set-default-value-of-namespace-prefix-in-XAML" class="headerlink" title="Set default value of namespace prefix in XAML."></a>Set default value of namespace prefix in XAML.</h3><p>The default value of XAML namespace in <code>WPF/UWP</code> is <code>x</code>. If we want to set default prefix for ourselves’s namespace, we can add a special <code>Attribute</code> to our namespace. Here is an example.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Windows.Markup;</span><br><span class="line">[<span class="meta">assembly: XmlnsPrefix(<span class="meta-string">"http://walterlv.github.io/demo"</span>, <span class="meta-string">"w"</span>)</span>]</span><br></pre></td></tr></table></figure></p>
<p>After you set this attribute, the XAML designer will use <code>w</code> as your prefix, when you add this namespace.</p>
<p>For more information,you can visit this blog:<br><a href="https://blog.walterlv.com/post/define-xmlns-of-for-xaml.html" target="_blank" rel="noopener">让你编写的控件库在 XAML 中有一个统一的漂亮的命名空间（xmlns）和命名空间前缀</a>.This blog was written in Chinese, I will translate it later.</p>
<p>It’s important to note that the defined component can’t be used in the same assembly!</p>
<h3 id="Use-your-controls-library-without-a-namespace-prefix-in-XAML"><a href="#Use-your-controls-library-without-a-namespace-prefix-in-XAML" class="headerlink" title="Use your controls library without a namespace prefix in XAML"></a>Use your controls library without a namespace prefix in XAML</h3><p>We write a usercontrol which’s name is <code>DemoPage</code>. Usually, we should add a namespace before we use it in XAML. But, there is a method to avoid adding a namespace before we use it.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">UserControl</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Class</span>=<span class="string">"HuyaHearhira.UserControl1"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">DemoPage</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">UserControl</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>The method is that we define the namespace as <code>http://schemas.microsoft.com/winfx/2006/xaml/presentation</code>.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Windows.Markup;</span><br><span class="line">[<span class="meta">assembly: XmlnsDefinition(<span class="meta-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>, <span class="meta-string">"Walterlv.NewCsprojDemo"</span>)</span>]</span><br></pre></td></tr></table></figure></p>
<p>It’s important to note that the defined component can’t be used in the same assembly!</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Neal chen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/badboy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Neal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/" itemprop="url">Write multiple 'Main' methods(.NET/C#), and switch to correct one.</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-10T16:27:10-06:00">
                2019-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="As-all-books-or-materials-showed-that-a-NET-C-application-starts-with-a-Main-method-But-we-can-write-multiple-Main-methods-in-our-project-then-we-can-choose-the-correct-one-you-wanted"><a href="#As-all-books-or-materials-showed-that-a-NET-C-application-starts-with-a-Main-method-But-we-can-write-multiple-Main-methods-in-our-project-then-we-can-choose-the-correct-one-you-wanted" class="headerlink" title="As all books or materials showed that a .NET/C# application starts with a Main method. But we can write multiple Main methods in our project, then we can choose the correct one you wanted."></a>As all books or materials showed that a .NET/C# application starts with a <code>Main</code> method. But we can write multiple <code>Main</code> methods in our project, then we can choose the correct one you wanted.</h4><h4 id="You-may-think-that-multiple-Main-is-useless-but-when-your-project-has-different-startup-processes-depend-on-different-compile-conditions-or-you-have-to-change-a-lot-of-codes-to-start-your-application-it-may-be-a-good-choice-to-write-multiple-Main-methods"><a href="#You-may-think-that-multiple-Main-is-useless-but-when-your-project-has-different-startup-processes-depend-on-different-compile-conditions-or-you-have-to-change-a-lot-of-codes-to-start-your-application-it-may-be-a-good-choice-to-write-multiple-Main-methods" class="headerlink" title="You may think that multiple Main is useless, but when your project has different startup processes depend on different compile conditions or you have to change a lot of codes to start your application, it may be a good choice to write multiple Main methods."></a>You may think that multiple <code>Main</code> is useless, but when your project has different startup processes depend on different compile conditions or you have to change a lot of codes to start your application, it may be a good choice to write multiple <code>Main</code> methods.</h4><hr>
<h2 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h2><blockquote>
<p>The original link is <a href="https://blog.walterlv.com/post/write-multiple-main-and-related-startup-codes.html" target="_blank" rel="noopener">.NET/C# 中你可以在代码中写多个 Main 函数，然后按需要随时切换 - walterlv</a>. But this blog was written in Chinese, so I translate its content to English. Waterlv is an MVP(Microsoft Most Valuable Professional), and he is good at .NET Core\WPF\.NET. Here is his <a href="https://blog.walterlv.com/" target="_blank" rel="noopener">Blog</a>.</p>
</blockquote>
<h3 id="Where-can-we-choose-the-correct-Main-method"><a href="#Where-can-we-choose-the-correct-Main-method" class="headerlink" title="Where can we choose the correct Main method."></a>Where can we choose the correct <code>Main</code> method.</h3><p>At the project which has <code>Main</code> method, the steps are listed below :<br><em>Right click (show menu items)-&gt;Properties-&gt;Application-&gt;Startup object</em> . As we can see,the default value of <em>startup object</em> is <em>Not set</em>.<br><img src="/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/2018-10-09-17-54-01.png" alt></p>
<h3 id="Choose-the-correct-Main-method"><a href="#Choose-the-correct-Main-method" class="headerlink" title="Choose the correct Main method."></a>Choose the correct <code>Main</code> method.</h3><p>If there are multiple <code>Main</code> methods, and we don’t select a value at <em>Startup object</em> (the value is “Not set”), we will get an error when we compile these codes.<br><img src="/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/2018-10-09-18-00-40.png" alt><br>Here is the message of the compile error.</p>
<blockquote>
<p>Error CS0017<br>The program has more than one entry point defined. Compile with /main to specify the type that contains the entry point.<br>Walterlv.Demo.Main C:\Users\lvyi\Desktop\Walterlv.Demo.Main\Walterlv.Demo.Main\NewProgram.cs</p>
</blockquote>
<p>We can fix this error by choosing the correct <code>Main</code> method.<br><img src="/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/2018-10-09-18-18-25.png" alt></p>
<h3 id="We-write-a-WPF-application"><a href="#We-write-a-WPF-application" class="headerlink" title="We write a WPF application"></a>We write a WPF application</h3><p>At this step, we can do some more complicated works that we changed the application to the WPF application.<br><img src="/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/2018-10-09-20-21-49.png" alt><br>Change the <em>startup object</em> to <code>Walterlv.Demo.App</code>.<br><img src="/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/2018-10-09-19-52-46.png" alt><br>Then, we start this WPF application.<br><img src="/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/2018-10-09-19-54-08.png" alt><br>It is important to note that, if you use new .csproj file in your project, the contents are as follows<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">"Microsoft.NET.Sdk"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>net472<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LanguageTargets</span>&gt;</span>$(MSBuildToolsPath)\Microsoft.CSharp.targets<span class="tag">&lt;/<span class="name">LanguageTargets</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">RootNamespace</span>&gt;</span>Walterlv.Demo<span class="tag">&lt;/<span class="name">RootNamespace</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">StartupObject</span>&gt;</span>Walterlv.Demo.App<span class="tag">&lt;/<span class="name">StartupObject</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">"PresentationCore"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">"PresentationFramework"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">"System.Xaml"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">"WindowsBase"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ApplicationDefinition</span> <span class="attr">Include</span>=<span class="string">"App.xaml"</span> <span class="attr">SubType</span>=<span class="string">"Designer"</span> <span class="attr">Generator</span>=<span class="string">"MSBuild:Compile"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Page</span> <span class="attr">Include</span>=<span class="string">"**\*.xaml"</span> <span class="attr">Exclude</span>=<span class="string">"App.xaml"</span> <span class="attr">SubType</span>=<span class="string">"Designer"</span> <span class="attr">Generator</span>=<span class="string">"MSBuild:Compile"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Compile</span> <span class="attr">Update</span>=<span class="string">"**\*.xaml.cs"</span> <span class="attr">DependentUpon</span>=<span class="string">"%(Filename)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>We keep the default code in App.xaml file.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Application x:Class=<span class="string">"Walterlv.Demo.App"</span></span><br><span class="line">             xmlns=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span><br><span class="line">             xmlns:x=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml"</span>&gt;</span><br><span class="line">&lt;/Application&gt;</span><br></pre></td></tr></table></figure></p>
<p>And the codes in App.xaml.cs file are pretty simple.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Walterlv.Demo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">App</span> : <span class="title">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStartup</span>(<span class="params">StartupEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> window = <span class="keyword">new</span> MainWindow();</span><br><span class="line">            window.Show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">base</span>.OnStartup(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>When we run the application now, the <code>Main</code> methods in <code>Program</code> file and <code>NewProgram</code> file do not work, because we set <code>Walterlv.Demo.App</code> as the value of <em>Startup Object</em>.</p>
<h3 id="Switch-different-startup-processes-depending-on-the-Startup-Object"><a href="#Switch-different-startup-processes-depending-on-the-Startup-Object" class="headerlink" title="Switch different startup processes depending on the Startup Object"></a>Switch different startup processes depending on the <em>Startup Object</em></h3><p>Now, you got a functional requirement </p>
<blockquote>
<p>The startup processes changes depending on the value of <em>Startup Object</em>.</p>
</blockquote>
<p>Specifically, if we start the <code>Main</code> method in <code>Program</code> file we startup an APP, also if we start <code>Main</code> in <code>NewProgram</code> we run another APP.<br>So, we can create a new file <code>APP.new.xaml.cs</code> which share the same xaml file (<code>APP.xaml</code>) with <code>App.xaml.cs</code>.<br>And we have to change the code in .csproj, the codes are as follow</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">"Microsoft.NET.Sdk"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>net472<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">LanguageTargets</span>&gt;</span>$(MSBuildToolsPath)\Microsoft.CSharp.targets<span class="tag">&lt;/<span class="name">LanguageTargets</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">RootNamespace</span>&gt;</span>Walterlv.Demo<span class="tag">&lt;/<span class="name">RootNamespace</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">StartupObject</span>&gt;</span>Walterlv.Demo.NewProgram<span class="tag">&lt;/<span class="name">StartupObject</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- region: added code--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PropertyGroup</span> <span class="attr">Condition</span>=<span class="string">" '$(StartupObject)' == 'Walterlv.Demo.Program' "</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- run app.xaml.cs --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">AppCsPath</span>&gt;</span>App.xaml.cs<span class="tag">&lt;/<span class="name">AppCsPath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PropertyGroup</span> <span class="attr">Condition</span>=<span class="string">" '$(StartupObject)' == 'Walterlv.Demo.NewProgram' "</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- run app.new.xaml.cs --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">AppCsPath</span>&gt;</span>App.new.xaml.cs<span class="tag">&lt;/<span class="name">AppCsPath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- endregion --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">"PresentationCore"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">"PresentationFramework"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">"System.Xaml"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">"WindowsBase"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ApplicationDefinition</span> <span class="attr">Include</span>=<span class="string">"App.xaml"</span> <span class="attr">SubType</span>=<span class="string">"Designer"</span> <span class="attr">Generator</span>=<span class="string">"MSBuild:Compile"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Page</span> <span class="attr">Include</span>=<span class="string">"**\*.xaml"</span> <span class="attr">Exclude</span>=<span class="string">"App.xaml"</span> <span class="attr">SubType</span>=<span class="string">"Designer"</span> <span class="attr">Generator</span>=<span class="string">"MSBuild:Compile"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Compile</span> <span class="attr">Update</span>=<span class="string">"**\*.xaml.cs"</span> <span class="attr">DependentUpon</span>=<span class="string">"%(Filename)"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--region: added code--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- remove all APP file,because they will be added later --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Compile</span> <span class="attr">Remove</span>=<span class="string">"App.xaml.cs"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Compile</span> <span class="attr">Remove</span>=<span class="string">"App.new.xaml.cs"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Compile</span> <span class="attr">Include</span>=<span class="string">"$(AppCsPath)"</span> <span class="attr">DependentUpon</span>=<span class="string">"App.xaml"</span> <span class="attr">SubType</span>=<span class="string">"Designer"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!--endregion--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>We can se that it add some judgement code in this <code>.csproj</code>, it can run deffirent <code>.xaml.cs</code> files depend on the value of <code>$(StartupObject)</code>.<br>Base on the above, we have different <code>.xaml.cs</code> file for different values of <em>Startup Object</em>. We can write different codes in these two files.<br>For example,the code in <code>App.new.xaml.cs</code> are as followed<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Walterlv.Demo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">App</span> : <span class="title">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStartup</span>(<span class="params">StartupEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> window = <span class="keyword">new</span> MainWindow</span><br><span class="line">            &#123;</span><br><span class="line">                Title = <span class="string">"New Walterlv Demo"</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">            window.Show();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">base</span>.OnStartup(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>They are different with the codes in <code>App.xaml.cs</code>,we change the title of window in these code.<br><img src="/2019/05/10/Write-multiple-Main-methods-and-you-can-switch-to-the-one-you-want/2018-10-09-20-19-57.png" alt></p>
<h3 id="Replace-files-with-conditional-compilers"><a href="#Replace-files-with-conditional-compilers" class="headerlink" title="Replace files with conditional compilers"></a>Replace files with conditional compilers</h3><p>If there are just a little differences among your startup processes in your project, you can use the conditional compiler to replace files.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;PropertyGroup Condition=<span class="string">" '$(StartupObject)' == 'Walterlv.Demo.Program' "</span>&gt;</span><br><span class="line">  &lt;DefineConstants&gt;$(DefineConstants);OLD&lt;/DefineConstants&gt;</span><br><span class="line">&lt;/PropertyGroup&gt;</span><br><span class="line">&lt;PropertyGroup Condition=<span class="string">" '$(StartupObject)' == 'Walterlv.Demo.NewProgram' "</span>&gt;</span><br><span class="line">  &lt;DefineConstants&gt;$(DefineConstants);NEW&lt;/DefineConstants&gt;</span><br><span class="line">&lt;/PropertyGroup&gt;</span><br></pre></td></tr></table></figure></p>
<p>Currently,you can use coditional compilers to control your startup processes.<br><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">using System.Windows;</span><br><span class="line"></span><br><span class="line">    namespace Walterlv.Demo</span><br><span class="line">    &#123;</span><br><span class="line">        public partial class App : Application</span><br><span class="line">        &#123;</span><br><span class="line">            protected override void OnStartup(StartupEventArgs e)</span><br><span class="line">            &#123;</span><br><span class="line">                var window = new MainWindow()</span><br><span class="line"><span class="addition">+   #if NEW</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Title = "New Walterlv Demo",</span><br><span class="line">                &#125;;</span><br><span class="line"><span class="addition">+   #endif</span></span><br><span class="line">                window.Show();</span><br><span class="line"></span><br><span class="line">                base.OnStartup(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/08/Find the window you wanted by using EnumWindows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Neal chen">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/badboy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Neal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/08/Find the window you wanted by using EnumWindows/" itemprop="url">Find the window you wanted by using EnumWindows</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-08T18:39:11-06:00">
                2019-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="During-the-development-of-windows-application-you-can-operate-other-windows-by-enumerating-windows-with-EnumWindows"><a href="#During-the-development-of-windows-application-you-can-operate-other-windows-by-enumerating-windows-with-EnumWindows" class="headerlink" title="During the development of windows application, you can operate other windows by enumerating windows with EnumWindows."></a>During the development of windows application, you can operate other windows by enumerating windows with <code>EnumWindows</code>.</h4><hr>
<h2 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h2><blockquote>
<p>The original link is <a href="https://blog.walterlv.com/post/find-specific-window-by-enum-windows.html#enumwindows" title="source" target="_blank" rel="noopener">使用 EnumWindows 找到满足你要求的窗口 - walterlv</a>. But this blog was written in Chinese, so I translate its content to English. Waterlv is an MVP(Microsoft Most Valuable Professional), and he is good at .NET Core\WPF\.NET. Here is his <a href="https://blog.walterlv.com/" target="_blank" rel="noopener">Blog</a>.</p>
</blockquote>
<h2 id="EnumWindows"><a href="#EnumWindows" class="headerlink" title="EnumWindows"></a><code>EnumWindows</code></h2><p>You can get more details about <code>EnumWindows</code> from the Microsoft website.</p>
<p>Before you use <code>EnumWindows</code> with <code>C#</code> , you have to write a platform to call the P/Invoke method. </p>
<p>Like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">DllImport(<span class="meta-string">"user32.dll"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">EnumWindows</span>(<span class="params">WndEnumProc lpEnumFunc, <span class="keyword">int</span> lParam</span>)</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Enumerate-all-top-level-windows"><a href="#Enumerate-all-top-level-windows" class="headerlink" title="Enumerate all top-level windows"></a>Enumerate all top-level windows</h2><p>This is the official document for this API description,</p>
<blockquote>
<p>Enumerates all top-level windows on the screen by passing the handle to each window, in turn, to an application-defined callback function.</p>
</blockquote>
<p>But not all the enumerated windows are top-level windows, some windows are not top-level windows.For more details,visit <a href="&quot;https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-enumwindows#remarks&quot;" title="remarks">EnumWindows remarks</a>.</p>
<p>So,we can get all windows by running these codes followed,</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IReadOnlyList&lt;<span class="keyword">int</span>&gt; <span class="title">EnumWindows</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> windowList = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">    EnumWindows(OnWindowEnum, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> windowList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">OnWindowEnum</span>(<span class="params"><span class="keyword">int</span> hwnd, <span class="keyword">int</span> lparam</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// you can add some conditions here.</span></span><br><span class="line">        windowList.Add(hwnd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Enumerate-windows-with-a-specific-title-or-class-name"><a href="#Enumerate-windows-with-a-specific-title-or-class-name" class="headerlink" title="Enumerate windows with a specific title or class name"></a>Enumerate windows with a specific title or class name</h2><p>You should add some Win32 API to filter windows. These APIs are the methods we plan to use.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get class name of specific window</span></span><br><span class="line">[<span class="meta">DllImport(<span class="meta-string">"user32.dll"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">GetClassName</span>(<span class="params"><span class="keyword">int</span> hWnd, StringBuilder lpString, <span class="keyword">int</span> nMaxCount</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get title of specific window</span></span><br><span class="line">[<span class="meta">DllImport(<span class="meta-string">"user32"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">GetWindowText</span>(<span class="params"><span class="keyword">int</span> hwnd, StringBuilder lptrString, <span class="keyword">int</span> nMaxCount</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>We can enumerate windows with specific class name by running the code,</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IReadOnlyList&lt;<span class="keyword">int</span>&gt; <span class="title">FindWindowByClassName</span>(<span class="params"><span class="keyword">string</span> className</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> windowList = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">    EnumWindows(OnWindowEnum, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> windowList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">OnWindowEnum</span>(<span class="params"><span class="keyword">int</span> hwnd, <span class="keyword">int</span> lparam</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> lpString = <span class="keyword">new</span> StringBuilder(<span class="number">512</span>);</span><br><span class="line">        GetClassName(hwnd, lpString, lpString.Capacity);</span><br><span class="line">        <span class="keyword">if</span> (lpString.ToString().Equals(className, StringComparison.InvariantCultureIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            windowList.Add(hwnd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Also, you can change the method from <code>GetClassName</code> to <code>GetWindowText</code> to enumerate windows by specific title.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lpString = <span class="keyword">new</span> StringBuilder(<span class="number">512</span>);</span><br><span class="line">GetWindowText(hwnd,lpString,lpString.Capacity);</span><br></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="&quot;https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-enumwindows&quot;" title="winuser">EnumWindows function (winuser.h) - Microsoft Docs</a></li>
<li><a href="&quot;https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-getclassname&quot;" title="GetClassName">GetClassName function (winuser.h) - Microsoft Docs</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/badboy.jpg" alt="Neal chen">
            
              <p class="site-author-name" itemprop="name">Neal chen</p>
              <p class="site-description motion-element" itemprop="description">.NET core\WPF\.NET</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:chentianlong0608@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Neal chen</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  











<script type="text/javascript">
    (function() {
        // 匿名函数，防止污染全局变量
        var utterances = document.createElement('script');
        utterances.type = 'text/javascript';
        utterances.async = true;
        utterances.setAttribute('issue-term','0')
        utterances.setAttribute('theme','')
        utterances.setAttribute('repo','getandplay/getandplay.github.io')
        utterances.crossorigin = 'anonymous';
        utterances.src = 'https://utteranc.es/client.js';
        // content 是要插入评论的地方
        document.getElementById('gitment-container').appendChild(utterances);
    })();
</script>

  





  

  

  

  
  

  

  

  

</body>
</html>
